{{- if .Values.ingress.enabled -}}
{{- $keycloakEnabled := .Values.keycloak.enabled -}}
{{- $keycloakFullname := include "keycloak.fullname" . -}}
{{- $keycloakServicePort := .Values.keycloak.ingress.servicePort -}}
{{- $gitlabEnabled := .Values.gitlab.enabled -}}
{{- $gitlabFullname := include "gitlab.fullname" . -}}
{{- $gitlabServicePort := 80 -}}
{{- $uiFullname := include "ui.fullname" . -}}
{{- $uiServicePort := .Values.ui.service.port -}}
{{- $uiserverFullname := include "uiserver.fullname" . -}}
{{- $uiserverServicePort := .Values.uiserver.service.port -}}
{{- $gatewayFullname := include "gateway.fullname" . -}}
{{- $gatewayServicePort := .Values.gateway.service.port -}}
{{- $graphEnabled := .Values.graph.enabled -}}
{{- $webhookServiceFullname := include "webhookService.fullname" . -}}
{{- $knowledgeGraphFullname := include "knowledgeGraph.fullname" . -}}
{{- $renkuFullname := include "renku.fullname" . -}}
{{- if $graphEnabled }}
{{- $jenaFullname := include "jena.fullname" . -}}
{{- $jenaServicePort := .Values.graph.jena.service.port -}}
{{- end }}
{{- $swaggerEnabled := .Values.swagger.enabled -}}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ template "renku.fullname" . }}
  labels:
    app: {{ template "renku.name" . }}
    chart: {{ template "renku.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
        more_set_headers "Content-Security-Policy: frame-ancestors 'self' {{ .Values.ui.baseUrl }}";      
{{- range $key, $value := .Values.ingress.annotations }}
    {{ $key }}: {{ $value | quote }}
{{- end }}
spec:
{{- if .Values.ingress.tls }}
  tls:
  {{- range .Values.ingress.tls }}
  - hosts:
    {{- range .hosts }}
    - {{ . }}
    {{- end }}
    secretName: {{ .secretName }}
  {{- end }}
{{- end }}
  rules:
  {{- range .Values.ingress.hosts }}
  - host: {{ . }}
    http:
      paths:
      {{- if $keycloakEnabled }}
      - path: /auth
        pathType: Prefix
        backend:
          service:
            name: {{ $keycloakFullname }}-http
            port:
              name: {{ $keycloakServicePort }}
      {{- end }}
      {{- if $gitlabEnabled }}
      - path: /gitlab
        pathType: Prefix
        backend:
          service:
            name: {{ $gitlabFullname }}
            port:
              number: {{ $gitlabServicePort }}
      {{- end }}
      - path: /repos
        pathType: Prefix
        backend:
          service:
            name: {{ $gatewayFullname }}
            port:
              number: {{ $gatewayServicePort }}
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: {{ include "traefik.fullname" . }}
            port:
              number: 80
      - path: /entities
        pathType: Prefix
        backend:
          service:
            name: {{ $gatewayFullname }}
            port:
              number: {{ $gatewayServicePort }}
      - path: /
        pathType: Prefix
        backend:
          service:
            name: {{ $uiFullname }}
            port:
              number: {{ $uiServicePort }}
      - path: /ui-server
        pathType: Prefix
        backend:
          service:
            name: {{ $uiserverFullname }}
            port:
              number: {{ $uiserverServicePort }}
      {{- if $graphEnabled }}
      - path: /webhooks/events
        pathType: Prefix
        backend:
          service:
            name: {{ $webhookServiceFullname }}
            port:
              number: 80
      - path: /knowledge-graph
        pathType: Prefix
        backend:
          service:
            name: {{ $knowledgeGraphFullname }}
            port:
              number: 80
      {{- end }}
      {{- if $swaggerEnabled }}
      - path: /swagger
        pathType: Prefix
        backend:
          service:
            name: {{ $renkuFullname }}-swagger
            port:
              number: 80
      {{- end }}
  {{- end }}
{{- end }}
